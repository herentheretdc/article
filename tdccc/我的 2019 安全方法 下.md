# åº

å¦‚æœé‚„æ²’æœ‰çœ‹é[ç¬¬ä¸€ç¯‡](https://blog.tdccc.com.tw/505/)çš„è«‹å…ˆå»æœç”¨ã€‚

# èŠ±åª½çš„æ–™ç†æ•™å®¤ DoReMiSo 

é€™ç¯‡æˆ‘å€‘ä¾†ä»‹ç´¹ä¸€ä¸‹å¦‚ä½•å®‰è£ AdGuard Home ï¼Œé€™é‚Šä½¿ç”¨ Docker ä¾†å®‰è£ï¼Œé€™æ¨£ä¸€ä¾†å°±ä¸ç”¨ç‰¹åœ°ç®¡ä»€éº¼å¹³å°æƒ¹ã€‚  

é¦–å…ˆæˆ‘å€‘éœ€è¦ä»€éº¼ï¼Ÿ  

-  ä¸€å° 24h é–‹è‘—çš„ä¸»æ©Ÿä¸”å¯ä»¥ `ssh` ä¸”å¯ä»¥å¤–é€£ `port-forward` 
- ä¸»æ©Ÿå®‰è£äº† `docker` & `docker-compose`
- ä¸€å€‹é•·æœŸç©©å®šçš„ domain ï¼ˆå»ºè­°ä»˜è²»ï¼‰
- domain è¨—ç®¡æ–¼ CloudFlare ï¼ˆæœ¬ç¯‡ç¤ºç¯„ï¼‰

## è£½é€ æ†‘è­‰

éƒ½ 9102 å¹´äº†ï¼Œå…è²»çš„æ†‘è­‰åˆ°è™•é£›ï¼Œé€™é‚Šä½¿ç”¨ç°¡å–®çš„ Let's Encrypt æ­é… Certbot è‡ªå‹•ç”¢ç”Ÿä»¥åŠ Renew æ†‘è­‰ï¼Œå‡è¨­å·²ç¶“æŠŠ domain è¨—ç®¡åˆ° CloudFlare ä¸Šäº†ä¹‹å¾Œé–‹å•Ÿ[é€™å€‹](https://www.cloudflare.com/a/account/my-account)ç¶²é é€²å…¥å€‹äºº CloudFlare å¸³è™Ÿé é¢ã€‚  

![alt](https://dr.sudo.host/iqsXEU+)

è¼¸å…¥å¸³è™Ÿå¾Œï¼Œé€šé Google ReCaptcha é©—è­‰è¤‡è£½ `Global API Key` è²¼åˆ° `Certbot/cloudflare.ini` ç¬¬ä¸€è¡Œå‰‡å¡«å…¥ä½ çš„ CloudFlare ç™»å…¥ä¿¡ç®±å¦‚ä¸‹åœ–ã€‚

![alt](https://dr.sudo.host/tkj4fj+)

æº–å‚™å¥½å¾Œä¾¿å¯ä»¥ä¾†ç”¢ç”Ÿæ†‘è­‰ï¼Œé€²å…¥ `Certbot` è³‡æ–™å¤¾å¾Œï¼Œå°‡ `<your@mail.com>` & `<your.domain>`  å…§çš„æ¨™ç¤ºæ›æˆå¯¦éš›åƒæ•¸ã€‚  

```shell
docker run --name certbot --rm -it \
-v "${PWD}/ssl:/etc/letsencrypt" \
-v "${PWD}/cloudflare.ini:/cloudflare.ini" \
certbot/dns-cloudflare \
certonly --dns-cloudflare \
--dns-cloudflare-credentials /cloudflare.ini \
--preferred-challenges dns-01 \
--agree-tos -m <your@mail.com> \
-d <your.domain>
```

ç†è«–ä¸Š `Certbot` åº•ä¸‹æœƒå¤šä¸€å€‹ `ssl` è³‡æ–™å¤¾ï¼Œè£¡é¢ `live` æ‡‰è©²æœƒå‡ºç¾ä¸€å€‹ä½ åŸŸåçš„è³‡æ–™å¤¾ã€‚å®Œæˆå¾Œå°±æº–å‚™å¥½äº†ã€‚

## è‡ªå‹•æ›´æ–°æ†‘è­‰

ä»€éº¼é€™éº¼ç…©ï¼Ÿ

å° ä¸çˆ½å»è²·æ†‘è­‰ã€‚

ä¾ç…§ [Let's Encrypt](https://letsencrypt.org/) ç™½çš®æ›¸ï¼Œä»–ç™¼æ”¾çš„æ†‘è­‰æœ‰æ•ˆæœŸé™åªæœ‰å¹¾å€‹æœˆï¼Œä½†æˆ‘ç¸½ä¸å¯èƒ½å¹¾å€‹æœˆå°±æ‰‹å‹• `Renew` ä¸€æ¬¡å§ï¼Œå¤ªæ“¾æ°‘äº†ã€‚å…¶å¯¦æˆ‘å€‘åªéœ€è¦æŠŠ `Certbot` æŒ‡ä»¤ä¿®æ”¹ä¸€ä¸‹ï¼Œæ”¾åˆ° `crontab` ä¸‹ä»–è‡ªå·±åŸ·è¡Œå³å¯ã€‚

```shell
crontab -e
```

æ¥è‘—é¸æ“‡è‡ªå·±å–œæ„›çš„ç·¨è¼¯å™¨ï¼Œåœ¨åº•ä¸‹æ’å…¥ï¼Œä¸¦è«‹ä¾ç…§å¯¦éš›è·¯å¾‘ä¿®æ”¹ `<PATH>` 

```shell
0 0 * * * docker run -it --rm --name certbot -v <PATH>/Certbot/ssl:/etc/letsencrypt -v <PATH>/Certbot/cloudflare.ini:/cloudflare.ini certbot/dns-cloudflare renew >/dev/null 2>&1
```



## å®‰è£ AdGuard Home  

é€²å…¥ AdGuardHome è³‡æ–™å¤¾å¾Œé€²å…¥æˆ‘å€‹äººæœ€æ„›çš„ç’°ç¯€ ~~æ¬¸ï¼~~ 

å…ˆåˆ¥æ€¥è‘—å•Ÿå‹•ï¼Œå…ˆå°‡è¨»è§£çš„ `docker-compose.yml` é–‹å•Ÿï¼Œä¸¦ä¸”å°‡ç¬¬å…«è¡Œè¨»è§£çš„åœ°æ–¹ä¿®æ”¹æˆå‰›å‰›ä¸Šé¢ç”¢ç”Ÿçš„æ†‘è­‰çš„éƒ¨åˆ†ï¼Œå°±æ˜¯ä½ çš„åŸŸåï¼Œè«‹å‹™å¿…è¨˜å¾—å°‡ `#` åˆªé™¤ã€‚

```yml
- ../Certbot/ssl/archive/blog.tdccc.com.tw:/ssl
```

ä¿®æ”¹å®Œç•¢å¾Œç›´æ¥ä½¿ç”¨æœ€æ£’çš„æŒ‡ä»¤ã€‚

```shell
docker-compose up
```

ç¢ºèªæ²’æœ‰å•Ÿå‹•å¤±æ•—å¾Œå¯ä»¥ç›´æ¥  `ctrl+z` ä¸Ÿå»å¾Œå°ï¼Œä¸¦å•Ÿå‹•ç€è¦½å™¨é€²å»ï¼Œ `http://<ip>:3000`

`ip` å³æ˜¯ä½ æ¶è¨­çš„åœ°é»ï¼Œæ¥è‘—åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ç›´æŒ‰ä¸‹ä¸€æ­¥äº†ã€‚

![alt](https://dr.sudo.host/Anlakh+)

![alt](https://dr.sudo.host/lAjM5Z+)

![alt](https://dr.sudo.host/3u446r+)

![alt](https://dr.sudo.host/VaicSy+)

æ¥è‘—å°±æœƒé€²å…¥å„€è¡¨æ¿çš„ä»‹é¢ï¼Œæ¥è‘—é»æ“Š `Settings` åšä¸€äº›è©³ç´°çš„è¨­å®šã€‚

![alt](https://dr.sudo.host/VK0xZf+)

ç¬¬ä¸€é …æ˜¯é»‘åå–®çš„æ›´æ–°é »ç‡ï¼Œé€™é‚Šå»ºè­°ç›´æ¥æ›´æ”¹ç‚º `1 hour` ã€‚

æ¥è‘— `Logs` æŸ¥è©¢/å°é– ç´€éŒ„å¦‚æœæœ‰éš±ç§ç–‘æ…®å»ºè­°ç›´æ¥é—œé–‰ä¸è¦å‹¾é¸ã€‚

![alt](https://dr.sudo.host/hcxJxr+)

åº•ä¸‹é‚„å¯ä»¥ä¸€éµå°é–æŒ‡å®šç¶²ç«™ ~~ç•¶ç„¶æˆ‘å»ºè­°ç›´æ¥æŠŠæŠ–é™°ç›´æ¥å¼„çˆ›~~

![alt](https://dr.sudo.host/eUgLqA+)

è¨­å®šå®Œå¾Œï¼Œåˆ¥å¿˜è¨˜é»æ“Š `Save` å„²å­˜è¨­å®šï¼Œæ¥è‘—ä¾†åˆ° `Encryption Settings`

é–‹å•ŸåŠ å¯†ä¹‹å¾Œï¼Œè¼¸å…¥ä¸Šé¢è¨­å®šå¥½çš„ç¶²åŸŸï¼Œä¸¦ä¸”é–‹å•Ÿè‡ªå‹•è½‰å€åˆ° `HTTPS` ã€‚

![alt](https://dr.sudo.host/XDvWhT+)

å¾€ä¸‹è½‰ä¾†åˆ°è¼¸å…¥æ†‘è­‰çš„åœ°æ–¹ï¼Œä¾åºè²¼ä¸Šã€‚

`/ssl/fullchain1.pem` & `/ssl/privkey1.pem` å³å¯ã€‚å¦‚æœå‡ºç¾éŒ¯èª¤çš„è©±ï¼Œä¾‹å¦‚æ‰¾ä¸åˆ°è³‡æ–™å¤¾è«‹å…ˆæª¢æŸ¥åœ¨è£½é€ æ†‘è­‰æ™‚æ˜¯å¦æœ‰æˆåŠŸï¼Œä¸¦ä¸” `docker-compose.yml` æœ‰æ­£ç¢ºæ›è¼‰å°‡ `#` æ‹¿æ‰ï¼Œå¦‚æœé‚„æ˜¯å‡ºç¾å•é¡Œå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ ï¼šï¼‰

![alt](https://dr.sudo.host/dGchGT+)



æ¥è‘—å„²å­˜å¾Œå°±å®Œæˆäº†ã€‚

## Filter åˆ°åº•è¦è£å“ªäº›ï¼Ÿ

ä¸Šä¸€ç¯‡æ–‡ç« å·²ç¶“æéå¯ä»¥åˆ° [filterlist](https://filterlists.com/) è£¡æ‰¾å°‹ç­”æ¡ˆã€‚é€™é‚Šå»ºè­°å¯ä»¥ä½¿ç”¨å¹¾å€‹é—œéµå­—ä¾†å°‹æ‰¾ï¼Œä¸éé‚„æ˜¯è¦å†èªªä¸€æ¬¡ã€‚

> éåº¦è¨‚é–±åˆ—è¡¨ï¼Œæœƒå½±éŸ¿é›»è…¦æ•ˆèƒ½ä»¥åŠå½±éŸ¿é é¢å‘ˆç¾ç•«é¢ï¼Œè«‹è‡ªè¡Œæ–Ÿé…Œè¨‚é–±ï¼Œå¦‚æœé‡åˆ°é é¢æ‰“ä¸é–‹ä¸å¦¨å…ˆé—œæ‰ AdGuard ä¸¦é‡æ–°æ•´ç†çœ‹çœ‹ ï¼šï¼‰

- Coin æˆ– Mining (æŒ–ç¤¦)
- Malware (æƒ¡æ„è»Ÿé«”)
- Phishing (é‡£é­šç¶²é )

é€™é‚Šä¹Ÿå…¬é–‹ä¸€ä¸‹æˆ‘å€‹äººè¨‚é–±çš„åˆ—è¡¨çµ¦å¤§å®¶å¥½æƒ¹

- [CoinBlocker](https://gitlab.com/ZeroDot1/CoinBlockerLists/raw/master/hosts)
- [MalwareDomainList.com](https://www.malwaredomainlist.com/hostslist/hosts.txt)
- [Phishing Hosts](https://gitlab.com/Kurobeats/phishing_hosts/raw/master/hosts)
- [Facebook Privacy List](http://www.squirrelconspiracy.net/abp/facebook-privacy-list.txt) (è‡‰æ›¸é‡åº¦ä½¿ç”¨è€…æ…ç”¨)

## å®¶ä¸­å…¶ä»–è¨­å‚™ï¼Ÿ

å¦‚æœå®¶ä¸­æœ‰å…¶ä»–è¨­å‚™æƒ³è¦ä½¿ç”¨ï¼Œä½†æ‡¶å¾—ä¸€å°ä¸€å°è¨­å®šçš„è©±å‘¢ ... ï¼Ÿå…¶å¯¦ä¹Ÿååˆ†ç°¡å–®ï¼Œé–‹å•Ÿå®¶ä¸­çš„è·¯ç”±å™¨ï¼Œå°‡ `DNS` æŒ‡å‘è¨­å®šå¥½çš„ `AdGuard Home ` å°±å¯ä»¥äº†ã€‚   

	### Router

![alt](https://dr.sudo.host/anqIzO+)

### PC 

é€™å€‹æˆ‘æ”¾æ£„ï¼Œæˆ‘æ ¹æœ¬ä¸ç”¨ Windows ![alt](https://dr.sudo.host/W3Qo0V+)

æˆ–æ˜¯åƒè€ƒä¸‹é¢çš„æ–¹æ³•ï¼Œä½¿ç”¨ `docker` æ¶è¨­ `knot`   

### Android

å¤§æ¦‚æ˜¯æœ€ç°¡å–®çš„æœ€å¿«é€Ÿã„‰

![alt](https://dr.sudo.host/gTLbO7+)

å¦‚æœæ˜¯æœ‰å®‰è£ `AdGuard` åœ¨æ‰‹æ©Ÿçš„ä¹Ÿå¯ä»¥é€™éº¼åšã€‚

![alt](https://dr.sudo.host/GDLuqG+)

### Mac / Linux

Mac å¿…é ˆå…ˆå®‰è£ [brew](https://brew.sh)

```shell
brew install knot-resolver services
```

Linux å…¶ä»– Distro å‰‡æ˜¯æŒ‰ç…§[å®˜ç¶²èªªæ˜](https://www.knot-resolver.cz/download/)æ¯”è¼ƒå¿«

åœ¨ç·¨å¯«è¨­å®šæª”ä¹‹å‰å…ˆå°‡é©—è­‰æ†‘è­‰çš„ `CA` ä¸‹è¼‰å¥½

Mac:  `curl -o /usr/local/etc/kresd/DigiCertGlobalRootCA.crt -L "https://dl.cacerts.digicert.com/DigiCertGlobalRootCA.crt"` 

Linux: `curl -o /etc/knot-resolver/DigiCertGlobalRootCA.crt -L "https://dl.cacerts.digicert.com/DigiCertGlobalRootCA.crt"`  

æ¥è‘—æ‰“é–‹ `knot` çš„è¨­å®šæª”è·¯å¾‘å¦‚ä¸‹ã€‚

Linux è¨­å®šæª”è·¯å¾‘ `/etc/knot-resolver/kresd.conf`

Mac è¨­å®šæª”è·¯å¾‘ `/usr/local/etc/kresd/config`

è«‹ç”¨è‡ªå·±å–œæ„›çš„ç·¨è¼¯å™¨é–‹å•Ÿï¼Œä¾‹å¦‚ `vim` (?)ï¼Œåœ¨æœ€å°¾ç«¯åŠ ä¸Šä¸¦è«‹ä¾ç…§å¯¦éš›ç‹€æ³ä¿®æ”¹ï¼ï¼ï¼ï¼

```ini
policy.TLS_FORWARD({{'<ip>', hostname='<domain>.',ca_file='<DigiCertGlobalRootCA.crt PATH>' }})
```

å„²å­˜é€€å‡ºä¹‹å¾Œå°‡ `knot` é‡å•Ÿå³å¯ã€‚  

Linux: `systemctl start kresd@{1..4}.service` [1](https://knot-resolver.readthedocs.io/en/stable/daemon.html#utilizing-multiple-cpus)  

Mac: `sudo brew services restart knot-resolver`  

æª¢æŸ¥ä¸€ä¸‹ `Log` æ˜¯å¦æœ‰å•Ÿå‹•å¤±æ•—çš„å•é¡Œã€‚  

Mac: `tail -f /usr/local/var/log/kresd.log`  

Linux: `tail -f /var/log/kresd.log`  

å¦‚æœæœ‰é‡åˆ°é¡¯ç¤ºæ‰¾ä¸åˆ° `root.key` çš„è©±å¯ä»¥å˜—è©¦å…ˆå°‡å®ƒè¨»è§£ `--` ğŸ¤”  

æ¥è‘—æˆ‘å€‘å¯ä»¥ä½¿ç”¨ `dig` é€™å¥—å·¥å…·ä¾†æ¸¬è©¦æ˜¯å¦è§£ææ­£å¸¸ï¼Œèªæ³•ä¹Ÿååˆ†ç°¡å–®ã€‚

```
$ dig @127.0.0.1 google.com
; <<>> DiG 9.10.6 <<>> @127.0.0.1 google.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27757
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;google.com.			IN	A

;; ANSWER SECTION:
google.com.		300	IN	A	172.217.160.78

;; Query time: 58 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Tue Dec 03 11:22:59 CST 2019
;; MSG SIZE  rcvd: 55
```

å¦‚æœæœ‰æ­£ç¢ºè§£æå°±æ˜¯æ­£å¸¸çš„å›‰ï¼ï¼Œé‚£æœ‰æ²’æœ‰æ¸¬è©¦æ­£å¸¸é˜»æ“‹ ...ï¼Ÿä¹Ÿè¶…ç´šç°¡å–®ã„‰ã€‚

```shell
$ dig @127.0.0.1 sa.bbc.com
; <<>> DiG 9.10.6 <<>> @134.209.108.164 sa.bbc.com
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 44462
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0

;; QUESTION SECTION:
;sa.bbc.com.			IN	A

;; AUTHORITY SECTION:
sa.bbc.com.		10	IN	SOA	fake-for-negative-caching.adguard.com. hostmaster.sa.bbc.com. 100500 1800 900 604800 86400

;; Query time: 96 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Tue Dec 03 11:25:28 CST 2019
;; MSG SIZE  rcvd: 109
```

åªè¦çœ‹åˆ° ```fake-for-negative-caching.adguard.com. hostmaster.sa.bbc.com. 100500 1800 900 604800 86400``` å°±æ˜¯ç›´æ¥è¢«é˜»æ“‹å›‰ï¼ŒçœŸçš„èˆ’æœã€‚ç•¶ä¸€åˆ‡å°±ç·’æ™‚ï¼Œå°±èƒ½å»ä¿®æ”¹é›»è…¦æœ¬æ©Ÿçš„ `DNS` æŒ‡å‘ `127.0.0.1` ã„Œ

![alt](https://dr.sudo.host/61vxmB+)

Linux å‰‡æ˜¯ç·¨è¼¯ `/etc/resolv.conf` å°‡åº•ä¸‹æ›¿æ›æˆ `127.0.0.1` å°±å¯ä»¥å›‰ã€‚

# EnJoy It

![alt](https://dr.sudo.host/YSTiIH+)

# Ref

- https://certbot-dns-cloudflare.readthedocs.io/en/stable/
- https://hub.docker.com/r/adguard/adguardhome
- https://github.com/docker/compose
- https://www.digicert.com/digicert-root-certificates.htm
- https://knot-resolver.readthedocs.io/en/stable